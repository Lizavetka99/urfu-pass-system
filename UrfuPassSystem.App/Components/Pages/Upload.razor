@using UrfuPassSystem.App.ArchiveHandler
@using UrfuPassSystem.App.ImageHandler
@using UrfuPassSystem.Domain.Entities

@page "/upload"
@rendermode InteractiveServer
@inject ILogger<Upload> Logger
@inject IArchiveHandler ArchiveHandler
@inject IImageHandler ImageHandler

<PageTitle>Добавить архив/фото</PageTitle>

<h1>Добавить архив/фото</h1>

<div style="margin-bottom: 20px; display: flex;">
    <div>Выберите файл:</div>
    <InputFile OnChange="FileUploaded" />
</div>

<h2>Выбранный файл:</h2>
<div>
    <img height="300" src="@Preview" />
    <div>Название: @FileName</div>
    <div>Размер: @FileSize.ToString("n0") (байт)</div>
    <div>Тип: @FileType</div>
</div>

<button type="button" class="btn btn-primary" @onclick="StartProcess">Обработать</button>

<div style="color: red;">@ErrorMessage</div>

<script lang="js">
    window.previewImage = (inputElem, imgElem) => {
        const url = URL.createObjectURL(inputElem.files[0]);
        imgElem.addEventListener('load', () => URL.revokeObjectURL(url), { once: true });
        imgElem.src = url;
    }
</script>

@code {
    public string FileName { get; set; } = "";
    public long FileSize { get; set; }
    public string FileType { get; set; } = "";
    public string? FilePath { get; set; }
    public string? Preview { get; set; }
    public string ErrorMessage { get; set; } = "";

    const int MAX_FILESIZE = 100 * 1024 * 1024; // 100 MB

    public async Task FileUploaded(InputFileChangeEventArgs e)
    {
        if (FilePath != null)
            File.Delete(FilePath);

        var file = e.File;
        if (file is null)
            return;

        FileSize = file.Size;
        FileType = file.ContentType;
        FileName = file.Name;

        var allowedExtensions = new[] { ".jpg", ".jpeg", ".png", ".jfif", ".heic" };
        var archiveExtensions = new[] { ".zip", ".rar" };
        var fileExtension = Path.GetExtension(FileName).ToLower();

        if (!allowedExtensions.Contains(fileExtension) && !archiveExtensions.Contains(fileExtension))
        {
            ErrorMessage = "Недопустимый тип файла. Разрешены только .jpg, .jpeg, .png, .jfif, .heic, .zip, .rar.";
            Preview = string.Empty;
            FilePath = null;
            return;
        }

        ErrorMessage = "";

        if (FileType.StartsWith("image"))
        {
            var buffer = new byte[FileSize];
            await file.OpenReadStream(MAX_FILESIZE).ReadAsync(buffer);
            Preview = $"data:{FileType};base64,{Convert.ToBase64String(buffer)}";
        }
        else
            Preview = string.Empty;

        var path = Path.GetFullPath(Path.Combine("images/temp", FileName));

        FilePath = path;

        await using var destinationStream = new FileStream(path, FileMode.Create);
        await file.OpenReadStream(MAX_FILESIZE).CopyToAsync(destinationStream);
    }

    private async Task StartProcess(MouseEventArgs e)
    {
        if (FilePath == null)
            return;

        var allowedExtensions = new[] { ".jpg", ".jpeg", ".png", ".jfif", ".heic" };

        if (FileType.Contains("zip") || FileType.Contains("rar"))
        {
            var randomFileName = Path.GetRandomFileName();
            var path = Path.GetFullPath(Path.Combine("images/temp", randomFileName));
            await ArchiveHandler.ExtractArchive(FilePath, path);

            var files = Directory.GetFiles(path, "*", SearchOption.AllDirectories);
            foreach (var file in files)
            {
                var fileExtension = Path.GetExtension(file).ToLower();
                if (!allowedExtensions.Contains(fileExtension))
                {
                    ErrorMessage = $"Архив содержит недопустимый файл: {Path.GetFileName(file)}";
                    Directory.Delete(path, true);
                    return;
                }
            }

            foreach (var file in files)
            {
                await SaveImage(file);
                File.Delete(file);
            }
            Directory.Delete(path, true);
        }
        else
        {
            var fileExtension = Path.GetExtension(FilePath).ToLower();
            if (!allowedExtensions.Contains(fileExtension))
            {
                ErrorMessage = "Недопустимый тип файла.";
                return;
            }
            await SaveImage(FilePath);
        }

        File.Delete(FilePath);
        Preview = null;
        FilePath = null;
        FileName = "";
        FileSize = 0;
        FileType = "";
        ErrorMessage = "";
    }

    private async Task SaveImage(string imagePath)
    {
        await ImageHandler.SaveImage(imagePath);
    }
}